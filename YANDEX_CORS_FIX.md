# YandexGPT CORS Fix - –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏–µ

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ" –¥–ª—è YandexGPT –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –ø–æ–ª—É—á–∞–ª–∞—Å—å –æ—à–∏–±–∫–∞:
```
Failed to fetch
```

### –ü—Ä–∏—á–∏–Ω–∞: CORS (Cross-Origin Resource Sharing)

**–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- **–§—Ä–æ–Ω—Ç–µ–Ω–¥** (–±—Ä–∞—É–∑–µ—Ä) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ `https://review-assistant.ru`
- **API Yandex** –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ `https://llm.api.cloud.yandex.net`
- –ë—Ä–∞—É–∑–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –¥–æ–º–µ–Ω–∞–º–∏ (CORS)
- –î–∞–∂–µ –µ—Å–ª–∏ –∫–ª—é—á –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–í–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ –∫ Yandex API, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ **backend'–µ** (—Å–µ—Ä–≤–µ—Ä–µ).

### –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:

```
[–ë—Ä–∞—É–∑–µ—Ä] 
    ‚Üì (fetch: /api/settings/yandex/check-key)
[–ù–∞—à Backend –Ω–∞ Python]
    ‚Üì (httpx: https://llm.api.cloud.yandex.net)
[Yandex Cloud API]
```

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

#### 1. **Frontend** (index.html, —Ñ—É–Ω–∫—Ü–∏—è `checkYandexHealth`)

**–ë—ã–ª–æ:**
```javascript
// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞
const response = await fetch('https://llm.api.cloud.yandex.net/llm/v1/completions', {
    headers: { 'Authorization': `Api-Key ${key}` },
    body: JSON.stringify({...})
});
```

**–°—Ç–∞–ª–æ:**
```javascript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ - –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ —Å–≤–æ–π backend
const response = await fetch(`${API_BASE}/settings/yandex/check-key`, {
    method: 'POST',
    body: JSON.stringify({
        api_key: key,
        folder_id: folderId,
        model: model
    })
});
```

#### 2. **Backend** –Ω–æ–≤—ã–µ endpoints

**POST `/api/settings/yandex/check-key`** (settings.py)
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç api_key, folder_id, model
- –°–æ–∑–¥–∞—ë—Ç YandexGPTService —Å —ç—Ç–∏–º–∏ —É—á—ë—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –í—ã–∑—ã–≤–∞–µ—Ç `check_api_health()` –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Å—Ä–µ–¥–µ —Å–µ—Ä–≤–µ—Ä–∞
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

**POST `/api/health/test-yandex`** (integrations.py)
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

#### 3. **YandexGPTService** –º–µ—Ç–æ–¥ `check_api_health()`

```python
async def check_api_health(self) -> Dict[str, Any]:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ API"""
    # –°–æ–∑–¥–∞—ë—Ç async HTTP –∫–ª–∏–µ–Ω—Ç
    async with httpx.AsyncClient(timeout=10) as client:
        response = await client.post(
            'https://llm.api.cloud.yandex.net/llm/v1/completions',
            headers={'Authorization': f'Api-Key {self.api_key}'},
            json={...}
        )
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç
        # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {"available": True/False, "error": "..."}
```

## üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –≤–≤–æ–¥–∏—Ç –≤ —Ñ–æ—Ä–º–µ:
   - YandexGPT API Key
   - Folder ID
   - –í—ã–±–∏—Ä–∞–µ—Ç –º–æ–¥–µ–ª—å

2. **–ù–∞–∂–∏–º–∞–µ—Ç** "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"

3. **JavaScript** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å –Ω–∞ `/api/settings/yandex/check-key`

4. **Backend** (Python):
   - –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
   - –°–æ–∑–¥–∞—ë—Ç YandexGPTService —Å —ç—Ç–∏–º–∏ –∫–ª—é—á–∞–º–∏
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ Yandex API **—Å–æ —Å–≤–æ–µ–≥–æ IP** (–Ω–µ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞)
   - –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

5. **JavaScript** –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
   - ‚úÖ "YandexGPT –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!" (–µ—Å–ª–∏ 200 OK)
   - ‚ùå "–û—à–∏–±–∫–∞: ..." (–µ—Å–ª–∏ –æ—à–∏–±–∫–∞)

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

| –ê—Å–ø–µ–∫—Ç | –ë—ã–ª–æ | –°—Ç–∞–ª–æ |
|--------|------|-------|
| **CORS** | ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º | ‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–π** | üîì –ö–ª—é—á –≤ –±—Ä–∞—É–∑–µ—Ä–µ | üîí –ö–ª—é—á —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ |
| **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** | ‚ùå –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –±—Ä–∞—É–∑–µ—Ä–∞ | ‚úÖ –°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ |
| **–°–∫–æ—Ä–æ—Å—Ç—å** | –ú–µ–¥–ª–µ–Ω–Ω–æ (–±—Ä–∞—É–∑–µ—Ä) | –ë—ã—Å—Ç—Ä–æ (–ø—Ä—è–º–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ) |

## üìù API Endpoints

### POST `/api/settings/yandex/check-key`

**Request:**
```json
{
    "api_key": "AQVN5k8Bv5fz...",
    "folder_id": "b1gXXX...",
    "model": "yandexgpt-3"
}
```

**Response (—É—Å–ø–µ—Ö):**
```json
{
    "status": "success",
    "is_valid": true,
    "message": "‚úÖ YandexGPT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!",
    "model": "yandexgpt-3",
    "available_models": [
        "yandexgpt-3",
        "yandexgpt-3-lite",
        "yandexgpt-4"
    ]
}
```

**Response (–æ—à–∏–±–∫–∞):**
```json
{
    "status": "auth_error",
    "is_valid": false,
    "message": "‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (401/403)",
    "details": "API Key –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–ª–∏ —É–¥–∞–ª–µ–Ω",
    "available_models": [...]
}
```

### POST `/api/health/test-yandex`

–ò–¥–µ–Ω—Ç–∏—á–Ω—ã–π endpoint –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è—Ö, –¥–ª—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

## üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –° –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (curl):

```bash
curl -X POST https://review-assistant.ru/api/settings/yandex/check-key \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "AQVN5k8Bv5fz...",
    "folder_id": "b1gXXX...",
    "model": "yandexgpt-3"
  }'
```

### –ò–∑ –±—Ä–∞—É–∑–µ—Ä–∞:

–ü—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∏ –Ω–∞–∂–º–∏ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ". –¢–µ–ø–µ—Ä—å –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!

## üìÇ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `frontend/index.html` - –§—É–Ω–∫—Ü–∏—è `checkYandexHealth()` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç backend endpoint
- `app/api/routes/settings.py` - –ù–æ–≤—ã–π endpoint `/yandex/check-key`
- `app/api/routes/integrations.py` - –ù–æ–≤—ã–π endpoint `/health/test-yandex`
- `app/services/yandex_service.py` - –ú–µ—Ç–æ–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è (—É–∂–µ –±—ã–ª–∏)

## ‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- **Credentials.** –ö–ª—é—á–∏ —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∞ backend, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS (–Ω–µ HTTP)
- **Timeout.** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∂–¥—ë—Ç –º–∞–∫—Å–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Yandex API
- **Quota.** –ï—Å–ª–∏ –∫–≤–æ—Ç–∞ –∏—Å—á–µ—Ä–ø–∞–Ω–∞, –≤–µ—Ä–Ω—ë—Ç—Å—è –æ—à–∏–±–∫–∞ 429
- **Models.** –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏: yandexgpt-3, yandexgpt-3-lite, yandexgpt-4
